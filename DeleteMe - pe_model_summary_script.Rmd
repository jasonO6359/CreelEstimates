## Index counts

```{r pe$effort_index_col}
pe$effort_index |>
  mutate(count_sequence = factor(count_sequence)) |> 
  ggplot(aes(event_date, count_index, fill = count_sequence, color = count_sequence)) +
  #geom_point() + geom_text(aes(label = count_index), nudge_y = 1, check_overlap = T) +
  geom_col(position = position_dodge(width = 0.7)) +
  scale_x_date("", date_breaks = "3 days", date_labels =  "%m-%d") + scale_y_continuous("") +
  scale_color_brewer(palette = "Set2", aesthetics = c("color", "fill")) +
  facet_wrap(~section + count_type + angler_type, scales = "free", ncol = 1, labeller = label_wrap_gen(multi_line = F))

```

## Census counts

```{r pe$effort_census}
# pe$effort_census |>
#   mutate(count_sequence = factor(count_sequence)) |> 
#   ggplot(aes(event_date, count_census, fill = count_sequence, color = count_sequence)) +
#   #geom_point() + geom_text(aes(label = count_census), nudge_y = 1, check_overlap = T) +
#   geom_col(position = position_dodge(width = 0.7)) +
#   scale_x_date("", date_breaks = "1 day") + scale_y_continuous("") +
#   scale_color_brewer(palette = "Set2", aesthetics = c("color", "fill")) +
#   facet_wrap(~section + angler_type, scales = "fixed", ncol = 1, labeller = label_wrap_gen(multi_line = F))

if(params$census_expansion == "Direct") {
pe$census_TI_expan |>
  ggplot(aes(count_index, count_census, color = angler_type)) +
  geom_abline(slope = 1, intercept = 0, linetype = 2) +
  scale_x_continuous(limits = c(0, NA)) +
  scale_y_continuous(limits = c(0, NA)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~paste("Section:",section), labeller = label_wrap_gen(multi_line = F))
}
```

## Total angler hours per interview

```{r pe$interview_dot_smooth}
pe$interview |>
  ggplot(aes(event_date, angler_hours_total, color = angler_type, fill = angler_type)) +
  geom_jitter(width = 0.1, alpha = 0.7) +
  geom_smooth(
    data = pe$interview |> group_by(section, angler_type, event_date) |> 
      summarise(angler_hours_total = median(angler_hours_total), .groups = "drop"),
    formula = y ~ x, method = "loess", se = F 
    ) +
  scale_x_date() +
  facet_wrap(~section + angler_type, scales = "free_x", ncol = 2, labeller = label_wrap_gen(multi_line = F)) 

```

## Catch

```{r pe$interview_and_catch}
pe$interview_and_catch |>
  group_by(section, time_strata, DayType, event_date, angler_type, catch_group) |> 
  summarise(fish_count = sum(fish_count), .groups = "drop") |> 
  filter(fish_count > 0) |>
  pivot_wider(names_from = catch_group, values_from = fish_count, names_sort = T) |> 
  mutate(section = paste("section", section)) |> 
  gt(groupname_col = "section", rowname_col = "event_date") |> 
  tab_options(container.overflow.x = T, container.overflow.y = T) |> 
  summary_rows(groups = TRUE, 
               columns = -c(section, time_strata, DayType, event_date, angler_type),
               fns = list(sum = ~sum(., na.rm = T)), 
               formatter = fmt_integer) |> 
  sub_missing() 
  
  # pivot_wider(names_from = angler_type, values_from = fish_count) |> 
  # gt(groupname_col = "catch_group", rowname_col = "event_date") |> 
  # sub_missing(c("bank", "boat"))

```

# Effort estimates

## Grand totals

```{r gt_effort_totals}
#by angler_type, summed over weekday/weekend and week/month
pe$est_effort_s_ts_dt_at |>
  group_by(section, angler_type) |>
  summarise(across(c(est, var), ~round(sum(., na.rm = T))), .groups = "drop") |> 
  pivot_wider(names_from = angler_type, values_from = c(est, var)) |> 
  select(section, contains("bank"), contains("boat")) |> 
  gt(caption = "Total angler hours, sum over temporal strata") |> 
  fmt_number(columns = -section, decimals = 0) |> 
  gt::summary_rows(columns = contains("est"), fns = list(sum = ~round(sum(., na.rm = T),0)), decimals = 0)

```

## Census-adjusted daily mean angler hours

```{r gg_angler_hours_daily_mean}
pe$angler_hours_daily_mean |> 
  ggplot(aes(event_date, ang_hrs_daily_mean_TI_expan, fill = angler_type)) +
  geom_col(position = position_stack()) +
  scale_x_date("", date_breaks = "3 day", guide = guide_axis(n.dodge = 2)) +
  scale_y_continuous("Hours") +
  facet_wrap(~section + DayType, scales = "fixed", labeller = label_wrap_gen(multi_line = F), ncol = 2) +
  labs(
    title = "Daily angler hours, sampled days",
    subtitle = "Day length * (Census-adjusted and interview-informed index counts)")
```

## Angler hours by section-time_strata-DayType-angler_type 

```{r gg_angler_hours_est_ribbons}
pe$est_effort_s_ts_dt_at |> 
  ggplot(aes(time_strata, fill = angler_type, color = angler_type)) +
  geom_ribbon(aes(y = est, ymin = l95, ymax = u95), alpha = 0.4) +
  geom_line(aes(y = est)) +
  scale_y_continuous("Hours") +
  facet_wrap(~section + DayType, scales = "fixed", labeller = label_wrap_gen(multi_line = F), ncol = 2) +
  labs(
    title = "Estimated angler hours by time strata",
    subtitle = "Section-time-strata-DayType-angler-type means * N-days")
```

## Cumulative angler hours by day and angler type

```{r gg_cumulative_ang_hours}
pe$est_effort_s_ts_dt_at |> 
  drop_na(est) |> 
  group_by(DayType, angler_type) |> 
  mutate(effort_cml = cumsum(est)) |> 
  ungroup() |> 
  ggplot(aes(time_strata, effort_cml, color = angler_type)) +
  geom_line() +
  scale_y_continuous("Hours") +
  facet_wrap(~section + DayType, scales = "fixed", labeller = label_wrap_gen(multi_line = F), ncol = 2) +
  labs(
    title = "Cumulative estimated angler hours, strata-means to complete days",
    subtitle = "Section-time-strata-DayType-angler-type means * N-days")
```

## Comparison of angler hour totals from effort counts and interviews

```{r pe$proportion_of_total_effort_sampled_from_interviews, eval=TRUE}

## produce chunk to evaluate proportion of estimated total angler hours (effort) sampled during interviews, grouped by angler type

pe$interview |>
  drop_na(angler_type) |>  
  group_by(time_strata, section, DayType, angler_type) |> 
  summarise(
    interview_hours_total = sum(angler_hours_total)
  ) |> 
  left_join(pe$est_effort_s_ts_dt_at |> ## join expanded catch estimates in pe$est_effort_s_ts_dt_at to total angler hours from interviews in pe$interview 
              select(section, time_strata, section, DayType, angler_type, effort_est = est) |>
               group_by(section, time_strata, DayType, angler_type) |> 
               summarise(
                 angler_effort_total = sum(effort_est))
             , 
            by = c("section", "time_strata", "DayType", "angler_type")) |> 
  group_by(section, angler_type) |> 
  summarise(
    interview_hours_total = sum(interview_hours_total),
    angler_effort_total = sum(angler_effort_total),
    proportion_interviewed_effort = (interview_hours_total / angler_effort_total)
    ) |>
  bind_rows(
    pe$interview |>
  drop_na(angler_type) |>  
  group_by(time_strata, section, DayType, angler_type) |> 
  summarise(
    interview_hours_total = sum(angler_hours_total)
  ) |> 
  left_join(pe$est_effort_s_ts_dt_at |> ## join expanded catch estimates in pe$est_effort_s_ts_dt_at to total angler hours from interviews in pe$interview 
              select(section, time_strata, section, DayType, angler_type, effort_est = est) |>
               group_by(section, time_strata, DayType, angler_type) |> 
               summarise(
                 angler_effort_total = sum(effort_est))
             , 
            by = c("section", "time_strata", "DayType", "angler_type")) |> 
  group_by(section) |> 
  summarise(
    interview_hours_total = sum(interview_hours_total),
    angler_effort_total = sum(angler_effort_total),
    proportion_interviewed_effort = (interview_hours_total / angler_effort_total)
    ) |> 
    mutate(
      angler_type = "total"
    )
  ) |> 
  mutate(across(where(is.numeric), round, 2)) |> 
  left_join(pe$section_table) |> 
  gt(groupname_col = "section_name") |> 
  cols_label(
    angler_type = md("angler type"),
    interview_hours_total = md("Total angler hours from direct sampling (interviews)"),
    angler_effort_total = md("Total angler hours from expanded effort estimates"),
    proportion_interviewed_effort = md("proportion of total effort sampled in interviews")
  ) |> 
  tab_header(
    title = md("Estimated total angler effort sampled during interviews"),
    subtitle = md("The season-long total of angler hours from interviews and effort counts. The third column displays the estimated proportion of total angling effort (angler hours) that was directly sampled during creel interviews.")) |> 
  tab_options(container.overflow.x = T, container.overflow.y = T)

```


```{r pe$proportion_effort_and_interview_hours_by_angler_type, eval=TRUE}

pe$interview |>
  drop_na(angler_type) |>  
  group_by(time_strata, section, DayType, angler_type) |> 
  summarise(
    interview_hours_total = sum(angler_hours_total)
  ) |> 
  left_join(pe$est_effort_s_ts_dt_at |> ## join expanded catch estimates in pe$est_effort_s_ts_dt_at to total angler hours from interviews in pe$interview 
              select(section, time_strata, section, DayType, angler_type, effort_est = est) |>
               group_by(section, time_strata, DayType, angler_type) |> 
               summarise(
                 angler_effort_total = sum(effort_est))
             , 
            by = c("section", "time_strata", "DayType", "angler_type"), .groups = "drop") |> 
  pivot_wider(names_from = angler_type, values_from = c("interview_hours_total", "angler_effort_total"), values_fill = 0) |>
  group_by(section) |>
  summarise(
     proportion_angler_effort_boat = sum(angler_effort_total_boat) / (sum(angler_effort_total_boat) + sum(angler_effort_total_bank)),
    proportion_interview_hours_boat = sum(interview_hours_total_boat) / (sum(interview_hours_total_boat) + sum(interview_hours_total_bank)),
    proportion_angler_effort_bank = sum(angler_effort_total_bank) / (sum(angler_effort_total_boat) + sum(angler_effort_total_bank)),
    proportion_interview_hours_bank = sum(interview_hours_total_bank) / (sum(interview_hours_total_boat) + sum(interview_hours_total_bank))) |>
  mutate(across(where(is.numeric), round, 2)) |>
  left_join(pe$section_table) |> 
  gt(groupname_col = "section_name") |> 
  tab_header(
    title = md("Proportion of angler hours from interviews and total effort estimates by angler type"),
    subtitle = md("Season-long proportions (prop.) of the sum total of angler hours by angler type (e.g., boat, bank) from total estimates of angler effort and angler interviews.")) |> 
  cols_label(
    proportion_angler_effort_boat = md("prop. boat angler hours in expanded effort estimates"),
    proportion_interview_hours_boat = md("prop. boat angler hours sampled from interviews"),
    proportion_angler_effort_bank = md("prop. bank angler hours in expanded effort estimates"),
    proportion_interview_hours_bank = md("prop. bank angler hours sampled from interviews")
  ) |>
  tab_options(container.overflow.x = T, container.overflow.y = T)

```

# Catch estimates

```{r gt_catch}
gt_catch <- function(cg_string, negate = F){
  if(negate){
    d <- filter(pe$est_catch_s_ts_dt_at, !str_detect(catch_group, cg_string))
  } else {
    d <- filter(pe$est_catch_s_ts_dt_at, str_detect(catch_group, cg_string))
  }
  if(nrow(d)>0){
    bind_rows(
      d |> group_by(section, DayType, angler_type, catch_group) |> 
        summarise(across(c(est, var), ~round(sum(.), 1)), .groups = "drop")
      ,
      d |> group_by(section, catch_group) |> 
        summarise(
          angler_type = "total", DayType = "total",
          est = round(sum(est), 1), .groups = "drop")
    ) |> 
      gt(groupname_col = c("section","catch_group")) |> 
      gt::fmt_number(columns = where(is.numeric), decimals = 1) |> 
      gt::sub_missing(columns = where(is.numeric)) |>
      gt::tab_style(
        style = gt::cell_text(weight = "bold"),
        locations = cells_body(columns = starts_with("est"), rows = DayType == "total")
      ) |> 
      gt::tab_style(
        style = gt::cell_fill(color = "#fc6508", alpha = 0.3),
        locations = cells_body(columns = contains("est"), rows = var/est > 5)
      ) |>  
      gt::tab_style(
        style = gt::cell_borders(sides = "left"),
        locations = cells_body(columns = starts_with("est"), rows = DayType != "total")
      ) |> 
      gt::tab_options(container.overflow.x = TRUE, container.overflow.y = TRUE)
  }
}

```

### Totals

```{r gt_total_by_catch_group}
pe$est_catch_s_ts_dt_at |> 
  group_by(catch_group) |> 
  summarise(est = round(sum(est), 1), .groups = "drop") |> 
  gt() |> 
  fmt_number(columns = where(is.numeric), decimals = 1)

```


### Chinook marked

```{r chin_adult_ad}
gt_catch("Chinook_Adult_AD")
```

### Chinook unmarked & unknown

```{r chin_adult_um}
gt_catch("Chinook_Adult_UM|Chinook_Adult_UNK")
```

### Coho

```{r coho}
gt_catch("Coho_Adult")
```

### Steelhead

```{r sthd}
gt_catch("Steelhead_Adult")
```

### Sockeye

```{r sockeye}
gt_catch("Sockeye_Adult")
```

### Jacks

```{r jacks}
gt_catch("Jack|Smolt|Steelhead_Unknown")
```

### Other species

```{r misc}
gt_catch(cg_string = "Chinook|Coho|Steelhead|Sockeye", negate = T)
```
